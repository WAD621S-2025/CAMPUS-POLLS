<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Campus Events - BUZZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="assets/js/theme.js"></script>
    <script src="assets/js/auth.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    .card-hover {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .progress-bar {
        transition: width 1s ease-out;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
    }
    .bee-mascot {
        animation: float 3s ease-in-out infinite;
    }

    .view-toggle-btn {
        transition: all 0.3s ease;
    }

    .view-toggle-btn.active {
        background-color: #f59e0b;
        color: white;
    }

    @layer utilities { 
        .border-blue-500, .bg-blue-500, .text-blue-700,
        .border-red-500, .bg-red-500, .text-red-700,
        .border-green-500, .bg-green-500, .text-green-700,
        .border-purple-500, .bg-purple-500, .text-purple-700,
        .border-gray-500, .bg-gray-500, .text-gray-700 {

            --tw-safelist: 1; 
        }
    }
</style>
</head>
<body class="bg-amber-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 flex flex-col min-h-screen relative z-0 transition-colors duration-300 font-inter">
    <div class="honeycomb-bg"></div>

    <header class="bg-gradient-to-r from-yellow-400 to-amber-500 dark:from-amber-600 dark:to-yellow-700 shadow-lg sticky top-0 z-50 transition-colors duration-300">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="flex items-center">
                    <i class="fas fa-university text-2xl text-gray-800 dark:text-gray-100 mr-2"></i>
                    <h1 class="text-xl font-bold text-gray-800 dark:text-gray-100">üêù BUZZ</h1>
                </a>
                <div class="hidden md:flex items-center space-x-4">
                    <a href="index.html" class="text-gray-800 dark:text-gray-100 hover:bg-white dark:hover:bg-gray-800 hover:bg-opacity-20 px-3 py-2 rounded-md text-sm font-medium transition">Home</a>
                    <a href="polls.html" class="text-gray-800 dark:text-gray-100 hover:bg-white dark:hover:bg-gray-800 hover:bg-opacity-20 px-3 py-2 rounded-md text-sm font-medium transition">Polls</a>
                    <a href="events.html" class="text-gray-800 dark:text-gray-100 font-semibold px-3 py-2 rounded-md text-sm bg-white dark:bg-gray-800 bg-opacity-30">Events</a>
                    <a href="memes.html" class="text-gray-800 dark:text-gray-100 hover:bg-white dark:hover:bg-gray-800 hover:bg-opacity-20 px-3 py-2 rounded-md text-sm font-medium transition">Memes</a>
                    <a href="about.html" class="text-gray-800 dark:text-gray-100 hover:bg-white dark:hover:bg-gray-800 hover:bg-opacity-20 px-3 py-2 rounded-md text-sm font-medium transition">About Us</a>
                </div>
                <div class="flex items-center space-x-4">
                     <button id="theme-toggle" class="theme-toggle p-2 rounded-md bg-white dark:bg-gray-800 bg-opacity-30 hover:bg-opacity-50 transition" title="Toggle Dark Mode">
                         <i class="fas fa-moon dark:hidden text-gray-800"></i>
                         <i class="fas fa-sun hidden dark:inline text-yellow-300"></i>
                     </button>
                     <a href="login.html" id="login-link" class="bg-gray-800 dark:bg-amber-500 text-amber-400 dark:text-gray-900 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-900 dark:hover:bg-amber-600 transition">Login / Sign Up</a>
                     <a href="user_profile.php" id="profile-link">
                         <img id="profile-avatar" class="h-8 w-8 rounded-full object-cover border-2 border-gray-800 dark:border-amber-400" src="https://placehold.co/100x100/fbbf24/1f2937?text=P" alt="User Avatar">
                     </a>
                </div>
            </div>
        </nav>
    </header>

    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8 relative z-10">
        <h2 class="text-3xl font-extrabold mb-8 text-gray-900 dark:text-gray-50 text-center">
            <i class="fas fa-calendar-alt mr-2 text-amber-500"></i> Campus Buzz Events
        </h2>

        <div id="message-container" class="mb-6"></div>

        <div class="space-y-8">
            <section id="create-event" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-t-4 border-amber-500 dark:border-yellow-500 transition-colors duration-300 card-hover">
                <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-50 border-b pb-2 border-amber-200 dark:border-gray-700">
                    <i class="fas fa-plus-circle mr-2 text-amber-500"></i> Post a New Event
                </h3>
                
                <form action="api/add_event.php" method="POST" class="space-y-4">
                    <div>
                        <input type="text" name="title" id="event-title" placeholder="Event Title (e.g., Annual Science Fair)"
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500 dark:bg-gray-700 dark:text-gray-100" required>
                    </div>

                    <div>
                        <label for="event-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date & Time</label>
                        <input type="datetime-local" name="event_date" id="event-date"
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500 dark:bg-gray-700 dark:text-gray-100" required>
                    </div>
                    
                    <div>
                        <textarea name="description" id="event-description" rows="3"
                                 class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500 dark:bg-gray-700 dark:text-gray-100"
                                 placeholder="Event description and location details..." required></textarea>
                    </div>
                    
                    <div class="flex items-center space-x-4 pt-2">
                        <label for="event-category" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300">
                            Category: 
                            <select name="category" id="event-category"
                                         class="ml-2 p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 focus:ring-amber-500 focus:border-amber-500"
                                         required>
                                <option value="academic">Academic</option>
                                <option value="social">Social</option>
                                <option value="sports">Sports</option>
                                <option value="workshop">Workshop</option>
                                <option value="other">Other</option>
                            </select>
                        </label>
                        <label class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300">
                            <input type="checkbox" name="is_public" value="1" checked class="form-checkbox h-4 w-4 text-amber-600 border-gray-300 rounded focus:ring-amber-500">
                            <span class="ml-2">Public Event</span>
                        </label>
                    </div>

                    <button type="submit" class="w-full bg-amber-600 text-white font-bold py-3 rounded-lg hover:bg-amber-700 transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
                        <i class="fas fa-calendar-plus mr-2"></i> Publish Event
                    </button>
                </form>
            </section>

            <section id="event-feed" class="space-y-6">
                <div class="flex justify-between items-center pb-2 border-b border-amber-300 dark:border-gray-700">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-50">
                        <i class="fas fa-clipboard-list mr-2 text-amber-500"></i> Upcoming Events
                    </h3>
                    <div class="relative flex items-center space-x-4">
                        <label for="event-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filter:</label>
                        <select id="event-filter" class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 text-sm">
                            <option value="all">All Events</option>
                            <option value="academic">Academic</option>
                            <option value="social">Social</option>
                            <option value="sports">Sports</option>
                            <option value="workshop">Workshop</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="bee-mascot fixed bottom-8 right-8 z-40 cursor-pointer hover:scale-110 transition-transform duration-300" title="Buzz the Bee!">
                    <div class="relative animate-bounce">
                        <span class="text-6xl filter drop-shadow-lg">üêù</span>
                        <div class="absolute -top-2 -right-2 bg-amber-500 text-white text-xs px-2 py-1 rounded-full animate-pulse">
                            Hi there!
                        </div>
                    </div>
                </div>

                <div id="events-container">
                    <div id="loading" class="flex justify-center items-center py-12">
                        <div class="loading"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400">Loading events...</span>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-gradient-to-r from-yellow-400 to-amber-500 dark:from-amber-600 dark:to-yellow-700 shadow-inner mt-auto relative z-10 transition-colors duration-300">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-gray-800 dark:text-gray-100">
            <p>&copy; 2025 BUZZ. All Rights Reserved.</p>
             <div class="flex justify-center space-x-4 mt-2">
                <a href="#" class="hover:text-white transition" title="Facebook"><i class="fab fa-facebook"></i></a>
                <a href="#" class="hover:text-white transition" title="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" class="hover:text-white transition" title="Instagram"><i class="fab fa-instagram"></i></a>
            </div>
        </div>
    </footer>

    <script>
        // Category colors mapping
        const categoryColors = {
            'academic': 'blue',
            'social': 'red',
            'sports': 'green',
            'workshop': 'purple',
            'other': 'gray'
        };

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Format time
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Create event card HTML (Consolidated and Corrected)
        function createEventCard(event) {
            const color = categoryColors[event.category] || 'gray';
            const displayDate = formatDate(event.event_date);
            const displayTime = formatTime(event.event_date);
            
            return `
                <div class="event-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-l-4 border-${color}-500 transition-colors duration-300 card-hover mb-6" data-category="${event.category}">
                    <div class="flex items-start justify-between mb-3">
                        <h4 class="text-xl font-bold text-gray-900 dark:text-gray-50">${escapeHtml(event.title)}</h4>
                        <span class="text-xs font-medium text-white bg-${color}-500 px-3 py-1 rounded-full shadow-md capitalize">${event.category}</span>
                    </div>
                    
                    <p class="text-gray-600 dark:text-gray-400 mb-4">${escapeHtml(event.description)}</p>
                    
                    <div class="flex flex-wrap items-center space-x-6 text-sm text-gray-700 dark:text-gray-300">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-day text-amber-500 mr-2"></i>
                            <span>${displayDate}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock text-amber-500 mr-2"></i>
                            <span>${displayTime}</span>
                        </div>
                        ${event.is_public == 1 ? `
                        <div class="flex items-center">
                            <i class="fas fa-globe text-amber-500 mr-2"></i>
                            <span>Public</span>
                        </div>
                        ` : ''}
                    </div>

                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                        <span>Location: ${escapeHtml(event.location || 'TBA')}</span>
                        <span>Posted: ${new Date(event.created_at).toLocaleDateString()}</span>
                    </div>

                    <div class="flex justify-end mt-4">
                        <button class="bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-amber-600 transition shadow-md text-sm">
                            <i class="fas fa-check mr-1"></i> RSVP
                        </button>
                    </div>
                </div>
            `;
        }

        function celebratePost() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#FCD34D', '#F59E0B', '#FBBF24']
            });
        }

        // Load events from API (Corrected endpoint for filtering)
        function loadEvents(filter = 'all') {
            const container = document.getElementById('events-container');
            const loadingHtml = `
                <div id="loading" class="flex justify-center items-center py-12">
                    <div class="loading"></div>
                    <span class="ml-3 text-gray-600 dark:text-gray-400">Loading events...</span>
                </div>
            `;
            container.innerHTML = loadingHtml; 
            
            // Construct API endpoint with filter
            const endpoint = filter === 'all' 
                ? 'api/get_events.php' 
                : 'api/get_events.php?category=${filter}';

            fetch(endpoint)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        displayEvents(data.events);
                    } else {
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <p class="text-red-600 dark:text-red-400">
                                    Error loading events: ${data.message || 'Unknown API error'}
                                </p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-600 dark:text-red-400">
                                Failed to load events. Please check your API endpoint (api/get_events.php).
                            </p>
                        </div>
                    `;
                });
        }


        // Display events on the page
        function displayEvents(events) {
            const container = document.getElementById('events-container');
            
            if (events.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-600 dark:text-gray-400">
                            No upcoming events found. Be the first to post one!
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = events.map(event => createEventCard(event)).join('');
        }

        // Show success/error messages
        function showMessage(type, message) {
            const container = document.getElementById('message-container');
            const bgColor = type === 'success' ? 'bg-green-100 border-green-500 text-green-700 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 border-red-500 text-red-700 dark:bg-red-900 dark:text-red-200';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            container.innerHTML = `
                <div class="alert ${bgColor} border-l-4 p-4 rounded-lg shadow-md flex items-center">
                    <i class="fas ${icon} mr-3 text-lg"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()" class="ml-auto">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Handle success/error messages from form submission
            if (urlParams.get('success') === '1') {
                showMessage('success', 'Event posted successfully!');
                celebratePost();
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (urlParams.get('error')) {
                const errorMessages = {
                    'missing_fields': 'Please fill in all required fields.',
                    'invalid_date': 'Invalid date format.',
                    'database': 'Database error. Please try again.',
                    'insert_failed': 'Failed to post event. Please try again.'
                };
                const errorMsg = errorMessages[urlParams.get('error')] || 'An unknown error occurred.';
                showMessage('error', errorMsg);
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            loadEvents();

            // Filter events by category
            document.getElementById('event-filter').addEventListener('change', function() {
                loadEvents(this.value);
            });
        });
    </script>
</body>
</html>